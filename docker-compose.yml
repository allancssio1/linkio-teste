services:
  linkio-db:
    image: mongo:8
    container_name: linkio-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: linkio
      MONGO_INITDB_ROOT_PASSWORD: linkio
      MONGO_INITDB_DATABASE: linkio_db
    ports:
      - '27017:27017'
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: linkio-api
    restart: unless-stopped
    ports:
      - '${PORT:-3333}:${PORT:-3333}'
    environment:
      NODE_ENV: ${NODE_ENV:-dev}
      PORT: ${PORT:-3333}
      HOST: ${HOST:-0.0.0.0}
      MONGODB_URI: mongodb://linkio:linkio@linkio-db:27017/linkio_db?authSource=admin
      JWT_SECRET: ${JWT_SECRET:-secret-test}
    depends_on:
      linkio-db:
        condition: service_healthy

volumes:
  mongodb_data:
